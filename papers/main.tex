% !TeX root = main.tex
\documentclass[number,times]{elsarticle}

\input{preamble.tex}

\begin{document}

\title{Resource Adequacy and Operational Security Interaction in the EPOC 2030-50 Project}

\maketitle

\newpage

\tableofcontents

\newpage

\section{Interaction description}

\todo[inline]{Fill in}

All code can be found at \href{https://github.com/junglegobs/ASoSEPOC}{https://github.com/junglegobs/ASoSEPOC}.

\section{Description of a Deterministic Unit Commitment Model with Probabilistic Reserve (DUC-PR) constraints}

\subsection{Sets}

\begin{itemize}
    \item $G$ - Generators
    \item $G_n$ - Generators located at node $n$
    \item $GD$ - Dispatchable / thermal / conventional generators
    \item $GR$ - Renewable / variable generators
    \item $N$ - Nodes or buses in the network
    \item $B$ - Lines or branches
    \item $T$ - Time steps / intervals / slices
    \item $L^+$ - Upward reserve levels
    \item $L^-$ - Downward reserve levels
\end{itemize}

\subsection{Parameters}

\begin{itemize}
    \item $D_{nt}$ - Demand
    \item $PTDF_{nl}$ - Power Transfer Distribution Factor
    \item $AF_{gt}$ - Availability Factor
    \item $K_g$ - Capacity
    \item $P^{min}_g$ - Minimum power output
    \item $P^{max}_g$ - Maximum power output
    \item $D^{L^+}_{lt}$ - Upward reserve requirement
    \item $D^{L^-}_{lt}$ - Downward reserve requirement
\end{itemize}

\subsection{Variables}

All variables are positive apart from injetion variables which may also be negative.

\begin{itemize}
    \item $q_{gt}$ - Generation
    \item $\hat{q}_{gt}$ - Generation above the minimum stable operating point (0 in the case of renewables).
    \item $ls_{nt}$ - Load shedding
    \item $inj_{nt}$ - Node injection
    \item $f_{lt}$ - Branch flow
    \item $r^+_{gt}$ - Total upward reserve provision
    \item $r^-_{gt}$ - Total downward reserve provision
    \item $r^{L^+}_{glt}$ - Upward reserve provision for reserve level $l$
    \item $r^{L^-}_{glt}$ - Downward reserve provision for reserve level $l$
    \item $rs_{nlt}$ - Upward reserve shedding for reserve level $l$
    \item $rc_{nlt}$ - Downward reserve provided by day ahead load shedding for reserve level $l$
    \item $rinj_{nlt}^{L^+}$ - Possible node injection due to activation of upward reserve level $l$
    \item $rinj_{nlt}^{L^-}$ - Possible node injection due to activation of downward reserve level $l$
    \item $rf_{nbt}^{L^+}$ - Possible branch flow due to activation of upward reserve level $l$
    \item $rf_{nbt}^{L^-}$ - Possible branch flow due to activation of downward reserve level $l$
    \item $d_{nlt}^{L^+}$ - Possible imbalance on node $n$ for upward reserve level $l$
    \item $d_{nlt}^{L^-}$ - Possible imbalance on node $n$ for downward reserve level $l$
\end{itemize}

\subsection{Objective}

\begin{align}
    \min \quad & \sum_{t \in T} \sum_{g \in G} C^{var}_{g} \cdot \hat{q}_{gt} \nonumber                                                                  \\
               & + \sum_{t \in T} \sum_{l \in L^+} \sum_{n \in N} P^{L^+} \cdot \sum_{g \in G} C^{var}_{g} \cdot r^{L^+}_{glt} + C^{shed} \cdot rs_{nlt} \\
               & - \sum_{t \in T} \sum_{l \in L^-} \sum_{n \in N} P^{L^-} \cdot C^{var}_{g} \cdot r^{L^-}_{gnlt} + C^{shed} \cdot rc_{nlt} \nonumber
\end{align}

From the top line to the bottom, the costs are those of dispatching generators and activating upwards or downwards reserves.

Costs related to unit commitment, $z_{gt}$, have been omitted for brevity though they are included in the model.

\subsection{Constraints}

\subsubsection{Day ahead constraints}

The power balance:

\begin{equation}
    \sum_{g \in G_n} q_{gt} + ls_{nt} = D_{nt} + inj_{nt} \quad n \in N, \; t \in T
\end{equation}

Note the use of the set $G_n$ to only allow generators at node $n$ to contribute to the power balance. Another way of describing this would have been through an incidence matrix.

Network constraints:

\begin{align}
    f_{bt} = \sum_{n \in N} PTDF_{nb} \cdot inj_{nt} & \quad b \in B, \; t \in T \\
    -F_b \leq f_{bt} \leq F_b                        & \quad b \in B, \; t \in T \\
    \sum_{n \in N} inj_{nt} = 0                      & \quad n \in N, \; t \in T \\
\end{align}

Constraints on generator output:

\begin{align}
    q_{gt} - r^{-}_{gt} \geq 0                    & \quad g \in GR, \; t \in T \\
    q_{gt} + r^{+}_{gt} \leq AF_{gt} \cdot K_g    & \quad g \in GR, \; t \in T \\
    q_{gt} - r^{-}_{gt} \geq P^{min} \cdot z_{gt} & \quad g \in GD, \; t \in T \\
    q_{gt} + r^{+}_{gt} \leq P^{max} \cdot z_{gt} & \quad g \in GD, \; t \in T
\end{align}

For brevity and clarity, constraints on ramping and minimum up and down times are omitted.

\subsubsection{Operating reserve (activation) constraints}

The constraints on reserve provision are as follows:

\begin{align}
    D^{L^+}_{lt} = \sum_{g \in G} r^{L^+}_{glt} + \sum_{n \in N} rs_{nlt} & \quad l \in L^+, \; t \in T \\
    D^{L^-}_{lt} = \sum_{g \in G} r^{L^-}_{glt} + \sum_{n \in N} rc_{nlt} & \quad l \in L^-, \; t \in T \\
    \sum_{l \in L^-} rc_{nlt} \leq ls_{nt}                                & \quad n \in N, \; t \in T   \\
    r^{+}_{gt} = \sum_{l \in L^+} r^{L^+}_{gnlt}                          & \quad g \in G, \; t \in T   \\
    r^{-}_{gt} = \sum_{l \in L^-} r^{L^-}_{gnlt}                          & \quad g \in G, \; t \in T
\end{align}

The amount of reserve shedding can be limited to a fraction of the total upward reserve requirements $RSL$:

\begin{equation}
    \sum_{n \in N, l \in L^+} rs_{nlt} \leq RSL \cdot \sum_{l \in L^+} D^{L^+}_{l't} \quad t \in T
\end{equation}

There are several matters to note here:

\begin{itemize}
    \item The operating reserve balance is performed over the entire network, not per node.
    \item The operating reserve balance is split into reserve levels. Higher reserve levels (values of $l$) are less likely to occur.
    \item It is possible to shed upward reserves, and this is more likely to occur for higher reserve levels. This model is therefore able to make a trade-off between day ahead adequacy and real time operational security, albeit crudely.
    \item Shedding load in day ahead allows additional downward reserves to be provided through the variable $rc_{nlt}$. Implicitly this assumes that load can be `activated' in real time to provide downward reserves.
\end{itemize}

\subsubsection{Operating reserve activation network constraints} \label{sec:operating_reserve_network_activation_constraints}

The following constraints attempt to take network constraints into account (albeit very weakly):

\begin{align}
    \sum_{g \in G_n, l'=1:l} (r^{L^+}_{glt} + rs_{nlt}) = d^{L^+}_{nlt} + rinj^{L^+}_{nlt}   & \quad n \in N, \; l \in L^+, \; t \in T \label{eq:reserve_network_activation_constraints_1} \\
    - \sum_{g \in G_n, l'=1:l} (r^{L^-}_{glt} + rc_{nlt}) = d^{L^-}_{nlt} + rinj^{L^-}_{nlt} & \quad n \in N, \; l \in L^-, \; t \in T                                                     \\
    \sum_{n \in N} d^{L^+}_{nlt} = \sum_{l'=1:l} D^{L^+}_{l't}                               & \quad l \in L^+, \; t \in T                                                                 \\
    \sum_{n \in N} d^{L^-}_{nlt} = - \sum_{l'=1:l} D^{L^-}_{l't}                             & \quad l \in L^-, \; t \in T                                                                 \\
    rf^{L^+}_{blt} = \sum_{n \in N} PTDF_{nb} \cdot rinj^{L^+}_{nlt}                         & \quad b \in B, \; l \in L^+, \; t \in T                                                     \\
    rf^{L^-}_{blt} = \sum_{n \in N} PTDF_{nb} \cdot rinj^{L^-}_{nlt}                         & \quad b \in B, \; l \in L^-, \; t \in T                                                     \\
    -F_{b} \leq f_{bt} + rf^{L^+}_{blt} \leq F_b                                             & \quad b \in B, \; l \in L^+, \; t \in T                                                     \\
    -F_{b} \leq f_{bt} + rf^{L^-}_{blt} \leq F_b                                             & \quad b \in B, \; l \in L^-, \; t \in T                                                     \\
    \sum_{n \in N} rinj^{L^+}_{nt} = 0                                                       & \quad l \in L^+, \; n \in N, \; t \in T                                                     \\
    \sum_{n \in N} rinj^{L^-}_{nt} = 0                                                       & \quad l \in L^-, \; n \in N, \; t \in T \label{eq:reserve_network_activation_constraints_2}
\end{align}

Since imbalances are aggregated across the network, a particular reserve level activation is not associated with an imbalance at the nodal level. The above constraints therefore enforce that for each reserve level $l$ and node $n$, there exists some combination of nodal imbalance, node injections, generator dispatches and line flows which would satisfy the network constraints AND the imbalance across the entire network.

\subsubsection{Further constraining reserve activation network constraints} \label{sec:further_constraining_operating_reserve_network_activation_constraints}

Given the formulation here, which uses reserve levels, i.e. quantiles, over the entire network to represent forecast errors, it is difficult to come up with more stringent conditions. However, we devised two ways of doing so. The first is to apply box constraints to the possible nodal imbalances:

\begin{align}
    d_{nt}^{min} \leq d_{nlt}^{L^+} \leq d_{nt}^{max} & \quad n \in N, \; l \in L^+, \; t \in T \\
    d_{nt}^{min} \leq d_{nlt}^{L^-} \leq d_{nt}^{max} & \quad n \in N, \; l \in L^-, \; t \in T
\end{align}

It is possible to calculate $d_{nt}^{min}$ and $d_{nt}^{max}$ since the quantiles for $D^{L^+}$ and $D^{L^-}$ are calculated based on forecast error scenarios which \emph{are} defined at the nodal level. These limits are shown in Figure \ref{fig:imbalance_range}. Clearly it is simply not possible to have an imbalance on some nodes, such as Coo (the location of Belgium's pumped hydro unit). Constraining $d_{nlt}^{L^+}$ and $d_{nlt}^{L^-}$ in this way is referred to as AbsImb later on.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.9\textwidth]{../plots/nodal_imbalance_investigation/imbalance_range}
    \caption{Range of possible imbalances for all hours of day 309.\label{fig:imbalance_range}}
\end{figure}

The other possibility is to restrict $d_{nlt}^{L^+}$ and $d_{nlt}^{L^-}$ to lie within the convex hull of all imbalances. This is illustrated in 2 dimensions in Figure \ref{fig:convex_hull_tihange} for the imbalances at Tihange 1 and 2. Clearly the imbalances are highly correlated, and constraining the possible nodal imbalances to lie within the convex hull exploits this in a way that box constraints would not be able to.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.9\textwidth]{../plots/nodal_imbalance_investigation/convex_hull_TIHANGE 1_TIHANGE 2}
    \caption{Illustration of convex hull constraints on $d_{nlt}^{L^+}$ and $d_{nlt}^{L^-}$. Blue circles are imbalance scenarios, shaded area is the convex hull, $d_{nt}^{min}$ and $d_{nt}^{max}$ are the x limits for TIHANGE 1 and the y limits for TIHANGE 2. \label{fig:convex_hull_tihange}}
\end{figure}

At the time of writing, this convex hull restriction led to model infeasibilities and so it is not

\section{Input data - stylised Belgian grid with a large amount of variable renewable energy sources}

\todo[inline]{For now, see README.md}

\section{Analysis of DUC-PR model results}

This analysis relates only to the 309th day of the year (November 5th).

\subsection{No operating reserves}

\tabref{tab:results_no_OR} lists results for an increasing level of technical constraints or increasingly inflexible system. While the objective more than doubles going from the simple linear economic dispatch model with no network constraints to the unit commitment model with network constraints, no load shedding occurs. Preventing simultaneous charging and discharging constraints does not affect results at all, implying that additional energy consumption (which is not physically possible) from storage does not aid congestion in this context.

\begin{table}[H]
    \centering
    \begin{tabular}{ccccc}
        \toprule
        UC  & DANet & PSCD & Load shedding [MWh] & Objective \\
        \midrule
            &       &      & 0.0                 & 101,916   \\
        \xm &       &      & 0.0                 & 212,558   \\
        \xm & \xm   &      & 0.0                 & 252,327   \\
        \xm & \xm   & \xm  & 0.0                 & 252,327   \\
        \bottomrule
    \end{tabular}
    \caption{Analysis of model results when operating reserves are not included. UC = Unit Commitment constraints, DANet = Day Ahead Network constraints, PSCD = Prevent Simultaneous Charging and Discharging constraints.}\label{tab:results_no_OR}
\end{table}

The dispatch for the model with and without unit commitment constraints and with network constraints is shown in \figref{fig:dispatch_base}. The addition of unit commitment constraints leads to storage dispatching and conventional units generating throughout the day. Interestingly, the amount of solar generation and storage dispatch is higher in the economic dispatch model and the model with unit commitment and network constraints. This may be because batteries and solar generators are located in buses where there is also load, favouring their usage.

\begin{figure}[H]
    \centering
    \begin{subfigure}[t]{0.7\textwidth}
        \centering
        \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base/dispatch}
        \caption{Economic dispatch model}
    \end{subfigure}
    \begin{subfigure}[t]{0.7\textwidth}
        \centering
        \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_UC=true/dispatch}
        \caption{Unit commitment model}
    \end{subfigure}
    \begin{subfigure}[t]{0.7\textwidth}
        \centering
        \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_UC=true_DANet=true/dispatch}
        \caption{Unit commitment model with day ahead network constraints}
    \end{subfigure}
    \caption{Dispatch schedules with and without operating reserves.\label{fig:dispatch_base}}
\end{figure}

\subsection{Probabilistic operating reserves with no reserve activation network constraints}

\begin{itemize}
    \item Unit commitment constraints lead to unavoidable load shedding.
    \item This result should be interpreted with caution however, since reserve provision is quite strict (storage can't provide reserves, non spinning reserves not modelled). If more flexibility would be available in terms of reserve provision then this might not occur.
    \item Network constraints are less problematic than unit commitment (cost increase of \~20,000 euros instead of \~500,000).
    \item Preventing simultaneous charge and discharge has a small but noticeable effect.
\end{itemize}

\begin{table}[ht]
    \centering
    \footnotesize
    \begin{tabular}{ccccccc}
        \toprule
        UC  & DANet & PSCD & RSL & Load shedding [MWh] & Reserve Shedding [MWh] & Objective \\
        \midrule
            &       &      & 0.0 & 0.0                 & 0.0                    & 117,290   \\
            &       &      & 0.5 & 0.0                 & 0.0                    & 117,290   \\
            &       &      & 1.0 & 0.0                 & 0.0                    & 117,290   \\
        \midrule
        \xm &       &      & 0.0 & 1,669               & 0.0                    & 645,679   \\
        \xm &       &      & 0.5 & 1,669               & 0.0                    & 645,679   \\
        \xm &       &      & 1.0 & 1,669               & 0.0                    & 645,679   \\
        \midrule
        \xm & \xm   &      & 0.0 & 1,669               & 0.0                    & 665,010   \\
        \xm & \xm   &      & 0.5 & 1,669               & 136                    & 657,010   \\
        \xm & \xm   &      & 1.0 & 1,669               & 136                    & 657,010   \\
        \midrule
        \xm & \xm   & \xm  & 0.0 & 1,669               & 0.0                    & 665,705   \\
        \xm & \xm   & \xm  & 0.5 & 1,669               & 136                    & 665,696   \\
        \xm & \xm   & \xm  & 1.0 & 1,669               & 136                    & 665,696   \\
        \bottomrule
    \end{tabular}
    \caption{Analysis of model results with operating reserves but no reserve activation network constraints. UC = Unit Commitment constraints, DANet = Day Ahead Network constraints, PSCD = Prevent Simultaneous Charging and Discharging constraints, RSL = Reserve Shedding Limit.}\label{tab:results_no_RANet}
\end{table}

\figref{fig:dispatch_simple_reserves} shows the dispatch for 3 models with operating reserves, the first a simple economic dispatch, then a unit commitment and then a unit commitment with network constraints. Similarly to before, network constraints lead to greater usage of solar and storage compared to the unit commitment model without.

\begin{figure}[H]
    \centering
    \begin{subfigure}[t]{0.7\textwidth}
        \centering
        \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_RSV=0.0/dispatch}
        \caption{No UC, no DANet, no PSCD, RSL is 0.0}
    \end{subfigure}
    \begin{subfigure}[t]{0.7\textwidth}
        \centering
        \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_UC=true_RSV=0.0/dispatch}
        \caption{UC, no DANet, no PSCD, RSL is 0.0}
    \end{subfigure}
    \begin{subfigure}[t]{0.7\textwidth}
        \centering
        \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_UC=true_DANet=true_RSV=0.0/dispatch}
        \caption{UC, DANet, no PSCD, RSL is 0.0}
    \end{subfigure}
    \caption{Dispatch schedules with and without operating reserves.\label{fig:dispatch_simple_reserves}}
\end{figure}

\begin{itemize}
    \item What's happening to reduce reserve shedding without reducing load shedding? Consider only the difference between $RSL$ 0.5 and 0.0 for the UC and DANet case.
    \item For $RSL = 0.5 $, load shedding occurs across all nodes for the 10th hour of the day. Reserve shedding occurs on one node, LATOUR, for the 9th hour.
    \item The commitment for the two values of $RSL$ is not different.
    \item The load shed in both cases is the same i.e. it is not shed in different places. It is also equal everywhere, which seems strange...
    \item To avoid reserve shedding, the cost increase appears to be simply from regulating the generation of 6 conventional generators - Eeklo Nord, Meerhout, Monce and the generators at TIHANGE 1 and TIHANGE 3. Various renewable generators also modify their output.
    \item This leads me to believe that economic load shedding is occurring, and that more conventional generators are generating and providing reserves in order to satisfy the reserve shedding limit.
\end{itemize}

The fact that upward operating reserves can be entirely satisfied while load shedding occurs signals to me that reserve provision is easier to provide than satisfying load. This is almost certainly due to the weak reserve activation network constraints. Further constraining these using the methods described in \secref{sec:further_constraining_operating_reserve_network_activation_constraints} attempts to address this, as will be detailed in the next section.

\subsection{Probabilistic operating reserves with reserve activation network constraints}

Including network reserve activation constraints, that is Constraints \ref{eq:reserve_network_activation_constraints_1} through \ref{eq:reserve_network_activation_constraints_1}, led to no discernible change in objective. This particular instance is not able to make a trade-off between day ahead adequacy and real time operational security. As a first attempt to overcome this issue, the load at all nodes was multiplied by a factor of 1.5. This gave the results shown in \tabref{tab:results_LM_1_5}.

\begin{table}[ht]
    \centering
    \footnotesize
    \begin{tabular}{cccccccc}
        \toprule
        UC  & DANet & PSCD & AbsImb & RSL & Load shedding [MWh] & Reserve Shedding [MWh] & Objective \\
        \midrule
            &       &      &        & 0.0 & 34,860              & 0                      & 7,827,724 \\
            &       &      &        & 0.5 & 16,346              & 19,257                 & 3,934,989 \\
            &       &      &        & 1.0 & 7,521               & 28,209                 & 2,463,656 \\
        \midrule
        \xm &       &      &        & 0.0 & 34,860              & 0                      & 7,969,802 \\
        \xm &       &      &        & 0.5 & 16,672              & 19,002                 & 4,133,637 \\
        \xm &       &      &        & 1.0 & 9,190               & 26,809                 & 2,892,401 \\
        \midrule
        \xm & \xm   &      &        & 0.0 & 42,008              & 0                      & 9,572,369 \\
        \xm & \xm   &      &        & 0.5 & 16,950              & 28,096                 & 4,310,407 \\
        \xm & \xm   &      &        & 1.0 & 15,482              & 29,604                 & 4,029,268 \\
        \midrule
        \xm & \xm   & \xm  &        & 0.0 & 42,008              & 0                      & 9,572,828 \\
        \xm & \xm   & \xm  &        & 0.5 & 16,950              & 28,096                 & 4,310,407 \\
        \xm & \xm   & \xm  &        & 1.0 & 15,482              & 29,604                 & 4,029,268 \\
        \midrule
        \xm & \xm   & \xm  & \xm    & 0.0 & 42,008              & 0                      & 9,572,828 \\
        \xm & \xm   & \xm  & \xm    & 0.5 & 16,950              & 28,096                 & 4,310,407 \\
        \xm & \xm   & \xm  & \xm    & 1.0 & 15,482              & 29,604                 & 4,029,268 \\
        \bottomrule
    \end{tabular}
    \caption{Analysis of model results with operating reserves and with reserve activation network constraints with load multiplied by a factor of 1.5. UC = Unit Commitment constraints, DANet = Day Ahead Network constraints, PSCD = Prevent Simultaneous Charging and Discharging constraints, RSL = Reserve Shedding Limit.}\label{tab:results_no_RANet}
\end{table}

With reference to \tabref{tab:results_LM_1_5}:

\begin{itemize}
    \item Even in this case, the reserve activation network constraints are not binding, since the AbsImb constraints do not alter the objective function.
    \item On the other hand, the trade-off between reserve shedding and load shedding can be seen now in all cases. This trade-off is also obvious when observing the objective function.
    \item Unit commitment constraints do relatively little to increase total costs, but this is unsurprising given that costs are dominated by load shedding.
    \item Day ahead network constraints increase load shedding considerably i.e. congestion also plays a role in increasing load shedding.
\end{itemize}

% Closer investigation at load shedding patterns for the model with UC and DANet (but no PSCD and AbsImb) reveals that all load shedding occurs at the start of the day (when the battery has not charged yet).

% \begin{figure}[H]
%     \centering
%     \begin{subfigure}[t]{0.7\textwidth}
%         \centering
%         \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_RSV=0.0/dispatch}
%         \caption{No UC, no DANet, no PSCD, RSL is 0.0}
%     \end{subfigure}
%     \begin{subfigure}[t]{0.7\textwidth}
%         \centering
%         \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_UC=true_RSV=0.0/dispatch}
%         \caption{UC, no DANet, no PSCD, RSL is 0.0}
%     \end{subfigure}
%     \begin{subfigure}[t]{0.7\textwidth}
%         \centering
%         \includegraphics[width=\textwidth]{../data/sims/main_model_runs/309/base_UC=true_DANet=true_RSV=0.0/dispatch}
%         \caption{UC, DANet, no PSCD, RSL is 0.0}
%     \end{subfigure}
%     \caption{Dispatch schedules with and without operating reserves.\label{fig:dispatch_simple_reserves}}
% \end{figure}

\end{document}
